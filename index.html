<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>תרגיל</title>

<!-- MathJax v3 -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(','\\)']],
      displayMath: [['\\[','\\]']],
      packages: {'[+]':['noerrors']}
    },
    loader: { load: ['[tex]/noerrors'] },
    chtml: { scale: 1.02, mtextInheritFont: true }
  };
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<!-- mathjs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

<style>
  :root{
    --bg:#0e1424; --panel:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
    --ring:#334155; --accent:#60a5fa; --ok:#34d399; --bad:#ef4444;
    --field:#1f2a3a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;direction:rtl}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:'Segoe UI','Tahoma','Arial','David','FrankRuehl',serif;text-align:right;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:22px}
  h1{font-size:1.35rem;margin:0 0 16px}

  /* Tabs */
  .tabs{display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap}
  .tab-btn{
    cursor:pointer; padding:8px 12px; border:1px solid var(--ring);
    background:var(--field); color:var(--ink); border-radius:10px; font-size:.95rem;
  }
  .tab-btn[aria-selected="true"]{border-color:var(--accent)}
  .tab-panel{display:none}
  .tab-panel.active{display:block}

  .grid{display:grid;grid-template-columns:1fr 1.2fr;gap:16px}
  @media (max-width:920px){.grid{grid-template-columns:1fr}}

  .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:14px 16px}
  .section-title{font-size:1.05rem;margin:0 0 10px;color:var(--ink)}

  label{font-size:.92rem;color:var(--muted);display:block}
  textarea{
    width:100%;background:var(--field);color:var(--ink);
    border:1px solid var(--ring);border-radius:12px;
    padding:10px 12px;font-size:1rem;line-height:1.5;outline:none;
    direction:ltr;text-align:left;font-family:monospace;
  }
  textarea:focus{border-color:var(--accent)}

  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px;justify-content:flex-start}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:var(--field);padding:6px 10px;border-radius:999px;font-size:.9rem}
  .btn{cursor:pointer;background:var(--field);border:1px solid var(--ring);color:var(--ink);padding:8px 12px;border-radius:10px}
  .btn:hover{border-color:var(--accent)}

  .status{font-size:.9rem;margin-top:6px;text-align:right}
  .status.ok{color:var(--ok)} .status.bad{color:var(--bad)}

  .render{
    background:#0b1020;border:1px dashed #243047;border-radius:12px;
    padding:14px 16px;min-height:96px;overflow:auto;direction:ltr;text-align:center;
  }
  .hint{color:var(--muted);font-size:.95rem;margin-top:8px;line-height:1.9}
  .monospace{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
  select{background:var(--field);color:var(--ink);border:1px solid var(--ring);border-radius:10px;padding:6px 8px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>תרגיל</h1>

    <!-- Tabs header -->
    <div class="tabs" role="tablist" aria-label="ניווט לשוניות">
      <button class="tab-btn" role="tab" aria-selected="true"  aria-controls="tab-ex"   id="tabbtn-ex">תרגיל</button>
      <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-h1"  id="tabbtn-h1">רמז 1</button>
      <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-h2"  id="tabbtn-h2">רמז 2</button>
      <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-sol" id="tabbtn-sol">הצגת הפתרון</button>
    </div>

    <!-- Panel: תרגיל -->
    <section class="tab-panel active" id="tab-ex" role="tabpanel" aria-labelledby="tabbtn-ex">
      <div class="grid">
        <!-- ימין: השאלה -->
        <aside class="card">
          <div class="section-title">השאלה</div>
          <div id="problemRender" class="render"></div>
        </aside>

        <!-- שמאל: תשובת הסטודנטים -->
        <section class="card">
          <div class="section-title">הזינו כאן את התשובה הסופית</div>

          <label for="inputRaw">קלט Plain או LaTeX</label>
          <textarea id="inputRaw" rows="6"
placeholder="דוגמה ב-LaTeX
y = C_1 e^{x} + C_2 e^{2x}"></textarea>

          <div class="controls">
            <span class="pill"><input type="checkbox" id="forceLatex"><label for="forceLatex" style="margin:0">כפיית מצב LaTeX</label></span>
            <button class="btn" id="btnClear">ניקוי</button>
            <button class="btn" id="btnCheck">בדיקת תשובה</button>
            <span class="pill">מצב בדיקה
              <select id="checkMode">
                <option value="general" selected>פתרון כללי</option>
              </select>
            </span>
          </div>

          <div id="status" class="status"></div>

          <label style="margin-top:10px;display:block">תצוגה</label>
          <div id="render" class="render"></div>

          <div id="checkMsg" class="status" style="margin-top:10px"></div>

          <div class="hint">
            • בדיקת נכונות פועלת בקלט Plain<br/>
            • הטקסט במסך אינו פתרון התרגיל אלא דוגמה לכתיבת משוואה ב-LaTeX<br/>
            • הציגו קבועים באותיות גדולות לדוגמה: A, B, C, D, K או C_1, C_2, D_1, D_2 • ניתן להשתמש ב: C*exp(x), C*e^x, או Ce^x
          </div>
        </section>
      </div>
    </section>

    <!-- Panel: רמז 1 -->
    <section class="tab-panel" id="tab-h1" role="tabpanel" aria-labelledby="tabbtn-h1">
      <div class="card">
        <div class="section-title">רמז 1</div>
        <div class="hint" id="hint1Box"></div>
      </div>
    </section>

    <!-- Panel: רמז 2 -->
    <section class="tab-panel" id="tab-h2" role="tabpanel" aria-labelledby="tabbtn-h2">
      <div class="card">
        <div class="section-title">רמז 2</div>
        <div class="hint" id="hint2Box"></div>
      </div>
    </section>

    <!-- Panel: הצגת הפתרון -->
    <section class="tab-panel" id="tab-sol" role="tabpanel" aria-labelledby="tabbtn-sol">
      <div class="card">
        <div class="section-title">שלד הפתרון</div>
        <!-- תשובה סופית גדולה וברורה -->
        <div class="render" id="solutionBox"></div>
        <!-- שלבים טקסטואליים נפרדים (כמו בגרסה הישנה) -->
        <div class="hint" id="solutionSteps" style="margin-top:10px"></div>
      </div>
    </section>

  </div>

<script>
/* =========================
   מבנה נתונים של תרגילים
   ========================= */
const problems = [
  {
    id: 'ode_second_order_homog_01',
    title: 'מסדר שני — הומוגנית',
    latexProblem: String.raw`פתרו את המשוואה ההומוגנית מסדר שני עם מקדמים קבועים:\; y'' - 3y' + 2y = 0`,
    hint1Html: `
      זוהי משוואה לינארית הומוגנית מסדר שני עם מקדמים קבועים.<br/>
      הביאו לצורה הבאה (המשוואה האופיינית): \\(r^2 - 3r + 2 = 0\\).<br/>
      קבלו את השורשים ובנו בעזרתם את הפתרון הכללי.
    `,
    hint2Html: `
      קבלו פירוק לגורמים: \\((r-1)(r-2)=0\\) ולכן \\(r_1=1,\\; r_2=2\\).<br/>
      בודדו את \\(y\\) לצורת פתרון כללי: \\(y(x)=C_1 e^{x}+C_2 e^{2x}\\).<br/>
      מותר לכתוב גם \\(\\exp(x)\\) במקום \\(e^x\\), וקבועים באותיות אחרות (A,B,K,M,C\\_1,C\\_2, ...).
    `,
    /* כמו אצלך: תצוגה למעלה + שלבים בנפרד */
    solutionDisplayLatex: String.raw`y = C_1 e^{x} + C_2 e^{2x}`,
    solutionStepsHtml: `
      **המשוואה האופיינית**: \\(r^2 - 3r + 2 = 0\\).<br/>
      שורשים: \\((r-1)(r-2)=0 \\Rightarrow r_1=1,\\; r_2=2\\).<br/>
      פתרון כללי: \\(y(x) = C_1 e^{x} + C_2 e^{2x}\\).<br/>
      בדיקה: \\(y' = C_1 e^{x} + 2C_2 e^{2x}\\), \\(y'' = C_1 e^{x} + 4C_2 e^{2x}\\).<br/>
      מציבים ב-\\(y''-3y'+2y\\) ומקבלים 0 לכל \\(x\\).
    `,
    /* שומרים את מנגנון הבדיקה שלך: (y - basePart)/fundamental = קבוע */
    check: {
      type: 'general_form',
      basePart: 'C1*exp(x)',
      fundamental: 'exp(2*x)'
    },
    exampleInput: String.raw`y = C1*exp(x) + C2*exp(2*x)`
  }
];

/* =========================
   Tabs
   ========================= */
(function(){
  const buttons = [...document.querySelectorAll('.tab-btn')];
  const panels  = [...document.querySelectorAll('.tab-panel')];
  function activate(id){
    buttons.forEach(b=>b.setAttribute('aria-selected', String(b.getAttribute('aria-controls')===id)));
    panels.forEach(p=>p.classList.toggle('active', p.id===id));
    if (window.MathJax?.typesetPromise) MathJax.typesetPromise(panels.filter(p=>p.id===id));
  }
  buttons.forEach(btn=>btn.addEventListener('click', ()=>activate(btn.getAttribute('aria-controls'))));
})();

/* =========================
   Render helpers
   ========================= */
function waitForLibraries(cb){
  let tries=0;(function check(){
    if (typeof math!=='undefined' && window.MathJax) cb();
    else if(tries++<100) setTimeout(check,50);
    else console.error('Libraries failed to load');
  })();
}
async function renderLatexTo(containerId, latex, display=true){
  const el = document.getElementById(containerId);
  el.innerHTML = display ? `\\[ ${latex} \\]` : `\\(${latex}\\)`;
  if (window.MathJax?.typesetPromise){
    try{ await MathJax.typesetPromise([el]) }catch{ el.innerHTML = `<div class="monospace">${latex}</div>` }
  }
}
function setHtml(id, html){
  const el = document.getElementById(id);
  el.innerHTML = html;
  if (window.MathJax?.typesetPromise){ MathJax.typesetPromise([el]); }
}

/* =========================
   Normalization & parsing
   ========================= */
function sanitizeBasic(s){ return (s||'').replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g,'').trim() }
function looksLikeLatex(s){ return /\\[a-zA-Z]+|\\\[|\\\]|\\\(|\\\)|\$(?!\s*$)|\\int|\\sum|\\frac|\\sqrt/.test(s) }
function insertImplicitMult(s){
  const id = '([A-Za-z](?:[A-Za-z0-9_]*))';
  s = s.replace(new RegExp(id + '\\s*(?=\\()', 'g'), '$1*');
  s = s.replace(new RegExp(id + '\\s*(?=\\b[xX]\\b)', 'g'), '$1*');
  s = s.replace(new RegExp(id + '\\s*e\\s*\\^', 'g'), '$1*e^');
  s = s.replace(new RegExp(id + '\\s*(?=\\b(?:sin|cos|tan|asin|acos|atan|exp|log|ln|sqrt|abs)\\b)', 'g'), '$1*');
  return s;
}
function convertMathNotation(s){
  s = s.replace(/\be\s*\^\s*\(/g, 'exp(');
  s = s.replace(/\be\s*\^\s*([a-zA-Z_]\w*|[0-9]+)/g, 'exp($1)');
  s = s.replace(/\be\s*\^\s*\{([^}]+)\}/g, 'exp($1)');
  s = s.replace(/\^/g, '**');
  return s;
}
function normalizeToPlain(s){
  let t = sanitizeBasic(s);
  t = t.replace(/^\s*[yY]\s*(\(\s*x\s*\))?\s*=\s*/, '');
  t = t.replace(/(\d),(\d)/g,'$1.$2');
  t = insertImplicitMult(t);
  t = convertMathNotation(t);
  return t;
}

/* =========================
   Checker (כללי)
   ========================= */
const currentCheck = { type:null, basePart:null, fundamental:null };

function dependsOnX(node){let dep=false; node.traverse(n=>{ if(n.isSymbolNode&&n.name==='x') dep=true}); return dep}
function hasFreeParamSymbolFromNode(node){
  let has=false; node.traverse(n=>{ if(n.isSymbolNode){const nm=n.name; if(nm!=='x'&&nm!=='e'&&nm!=='pi') has=true} }); return has
}
function trySymbolicZero(expr){ try{const s=math.simplify(expr).toString().replace(/\s+/g,''); return s==='0'||/^0(\*.*)?$/.test(s)}catch{return false} }

function checkGeneralSolution(userRaw){
  const user = normalizeToPlain(userRaw); if(!user) return false;
  try{
    const g = math.simplify(`(${user}) - (${currentCheck.basePart})`);
    const h = math.simplify(`(${g.toString()}) / (${currentCheck.fundamental})`);
    const hStr = h.toString(), hNode = math.parse(hStr);
    if (dependsOnX(hNode)) return false;
    if (trySymbolicZero(hStr)) return false;
    if (!hasFreeParamSymbolFromNode(hNode)) return false;
    return true;
  }catch{ return false }
}

/* =========================
   UI wiring + loadProblem
   ========================= */
waitForLibraries(function(){
  const inputEl = document.getElementById('inputRaw');
  const forceLatexEl = document.getElementById('forceLatex');
  const btnClear = document.getElementById('btnClear');
  const btnCheck = document.getElementById('btnCheck');

  function setStatus(msg, cls){
    const el = document.getElementById('status');
    el.className = `status ${cls||''}`;
    el.textContent = (msg||'') + (cls==='ok' ? '  @ open university' : '');
  }

  let debTimer=null; function debounce(fn,ms=180){ clearTimeout(debTimer); debTimer=setTimeout(fn,ms) }
  async function process(){
    const raw0 = inputEl.value, raw = sanitizeBasic(raw0);
    if(!raw){ document.getElementById('render').innerHTML=''; setStatus('',''); return }
    const forced = forceLatexEl.checked, latexMode = forced || looksLikeLatex(raw);
    try{
      if(latexMode){
        await renderLatexTo('render', raw, true);
        setStatus('מעובד במצב LaTeX', 'ok');
      }else{
        const plain = normalizeToPlain(raw);
        const node = math.parse(plain);
        const latex = node.toTex({ parenthesis:'keep', implicit:'show' });
        await renderLatexTo('render', latex, true);
        setStatus('מעובד במצב Plain → LaTeX באמצעות mathjs', 'ok');
      }
    }catch(err){
      document.getElementById('render').innerHTML =
        `<div class="monospace">שגיאה בעיבוד\n${(err?.message||String(err))}\n\nקלט\n${raw}</div>`;
      setStatus('שגיאה בעיבוד — לבדוק תחביר', 'bad');
    }
  }

  inputEl.addEventListener('input', ()=>debounce(process,120));
  forceLatexEl.addEventListener('change', process);
  document.getElementById('btnClear').addEventListener('click', ()=>{
    inputEl.value=''; document.getElementById('render').innerHTML=''; setStatus('','');
    document.getElementById('checkMsg').textContent=''; inputEl.focus();
  });
  document.getElementById('btnCheck').addEventListener('click', ()=>{
    const raw0 = inputEl.value, raw = sanitizeBasic(raw0);
    const latexMode = looksLikeLatex(raw) && !forceLatexEl.checked;
    const el = document.getElementById('checkMsg');
    if(latexMode){ el.className='status bad'; el.textContent='בדיקת נכונות פועלת בקלט Plain'; return }
    const ok = checkGeneralSolution(raw0);
    el.className='status ' + (ok?'ok':'bad'); el.textContent = ok ? 'תשובה נכונה' : 'תשובה לא נכונה';
  });

  // טעינת תרגיל לפי אינדקס
  async function loadProblem(index=0){
    const p = problems[index];
    currentCheck.type = p.check.type;
    currentCheck.basePart = p.check.basePart;
    currentCheck.fundamental = p.check.fundamental;

    await renderLatexTo('problemRender', p.latexProblem, true);
    // תשובה סופית בגדול
    await renderLatexTo('solutionBox', p.solutionDisplayLatex, true);
    // שלדי השלבים מתחת, כטקסט עם LaTeX
    setHtml('solutionSteps', p.solutionStepsHtml);
    setHtml('hint1Box', p.hint1Html);
    setHtml('hint2Box', p.hint2Html);

    const inputEl2 = document.getElementById('inputRaw');
    inputEl2.value = p.exampleInput || '';
    (typeof process === 'function') && process();
  }

  // טוען את התרגיל הראשון במבנה הנתונים
  loadProblem(0);
});
</script>
</body>
</html>
